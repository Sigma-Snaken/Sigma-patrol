services:
  nginx:
    image: nginx:alpine
    container_name: visual_patrol_nginx
    network_mode: host
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

  robot-a:
    container_name: visual_patrol_robot_a
    image: ghcr.io/sigma-snaken/visual-patrol:latest
    network_mode: host
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      - DATA_DIR=/app/data
      - LOG_DIR=/app/logs
      - TZ=Asia/Taipei
      - PORT=5001
      - ROBOT_ID=robot-a
      - ROBOT_NAME=Robot A
      - ROBOT_IP=192.168.50.133:26400
      - MEDIAMTX_INTERNAL=localhost:8555
      - MEDIAMTX_EXTERNAL=localhost:8555
      - RELAY_SERVICE_URL=http://localhost:5020
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5001/api/state')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  rtsp-relay:
    container_name: visual_patrol_rtsp_relay
    image: ghcr.io/sigma-snaken/visual-patrol-relay:latest
    network_mode: host
    runtime: nvidia
    volumes:
      - ./logs:/app/logs
    environment:
      - LOG_DIR=/app/logs
      - TZ=Asia/Taipei
      - RELAY_SERVICE_PORT=5020
      - MEDIAMTX_HOST=localhost:8555
      - USE_NVENC=false
    restart: unless-stopped

  # robot-b:
  #   container_name: visual_patrol_robot_b
  #   image: ghcr.io/sigma-snaken/visual-patrol:latest
  #   network_mode: host
  #   volumes:
  #     - ./data:/app/data
  #     - ./logs:/app/logs
  #   environment:
  #     - DATA_DIR=/app/data
  #     - LOG_DIR=/app/logs
  #     - TZ=Asia/Taipei
  #     - PORT=5002
  #     - ROBOT_ID=robot-b
  #     - ROBOT_NAME=Robot B
  #     - ROBOT_IP=192.168.50.134:26400
  #     - MEDIAMTX_INTERNAL=localhost:8555
  #     - MEDIAMTX_EXTERNAL=localhost:8555
  #   restart: unless-stopped
